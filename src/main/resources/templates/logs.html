<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Жүйе журналдары</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script th:src="@{/js/admin.js}" defer></script>
    <style>
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .log-table th,
        .log-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .log-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            position: relative;
            cursor: pointer;
        }

        .log-table th:hover {
            background-color: #e9ecef;
        }

        .log-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .log-level {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 500;
        }

        .level-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .level-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .level-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .level-debug {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .log-details {
            background-color: #f8f9fa;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ecf0f1;
            display: none;
        }

        .log-details pre {
            margin: 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }

        .search-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }

        .date-range {
            display: flex;
            gap: 10px;
        }

        .date-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .log-action-btn {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

        .page-item {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-item.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-item.disabled {
            color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="admin-dashboard">
<div th:replace="fragments/sidebar :: adminSidebar"></div>

<div class="admin-content">
    <div class="admin-header">
        <h1 class="admin-title" th:text="${pageTitle}">Жүйе журналдары</h1>
        <div class="admin-actions">
            <a th:href="@{/admin/logs/export}" class="btn btn-outline-primary">Экспорттау</a>
            <button id="clear-logs" class="btn btn-outline-danger">Тазалау</button>
        </div>
    </div>

    <div id="admin-alert-container"></div>


    <div class="table-responsive">
        <table class="log-table">
            <thead>
            <tr>
                <th data-sort="timestamp">Уақыт</th>
                <th data-sort="level">Деңгей</th>
                <th data-sort="user">Пайдаланушы</th>
                <th data-sort="action">Әрекет</th>
                <th data-sort="ip">IP мекенжайы</th>
                <th>Толық мәлімет</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="log, iterStat : ${logs}">
                <td th:text="${#temporals.format(log.timestamp, 'yyyy-MM-dd HH:mm:ss')}">2023-10-15 15:30:42</td>
                <td>
                    <span class="log-level"
                          th:classappend="${'level-' + log.level.toString().toLowerCase()}"
                          th:text="${log.level}">INFO</span>
                </td>
                <td th:text="${log.username}">azamat</td>
                <td th:text="${log.action}">Жүйеге кіру</td>
                <td th:text="${log.ipAddress}">192.168.1.100</td>
                <td><span class="log-action-btn" th:onclick="'toggleLogDetails(' + ${log.id} + ')'">Көру</span></td>
            </tr>
            <tr th:each="log, iterStat : ${logs}">
                <td colspan="6" class="p-0">
                    <div th:id="'log-details-' + ${log.id}" class="log-details">
                        <pre>
{
  "timestamp": "[[${#temporals.format(log.timestamp, 'yyyy-MM-dd HH:mm:ss')}]]",
  "level": "[[${log.level}]]",
  "user": "[[${log.username}]]",
  "action": "[[${log.action}]]",
  "ip": "[[${log.ipAddress}]]"[[${log.userAgent != null ? ',' : ''}]]
  [[${log.userAgent != null ? '"userAgent": "' + log.userAgent + '"' : ''}]][[${(log.userAgent != null && (log.sessionId != null || log.details != null || log.stackTrace != null)) ? ',' : ''}]]
  [[${log.sessionId != null ? '"sessionId": "' + log.sessionId + '"' : ''}]][[${(log.sessionId != null && (log.details != null || log.stackTrace != null)) ? ',' : ''}]]
  [[${log.details != null ? '"details": "' + log.details + '"' : ''}]][[${(log.details != null && log.stackTrace != null) ? ',' : ''}]]
  [[${log.stackTrace != null ? '"stackTrace": "' + log.stackTrace + '"' : ''}]]
}
                        </pre>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination" th:if="${totalPages > 0}">
        <a class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}"
           th:href="@{/admin/logs(page=${currentPage - 1}, size=10, search=${search}, level=${level}, startDate=${startDate}, endDate=${endDate})}"
           th:unless="${currentPage == 0}">Алдыңғы</a>

        <span class="page-item disabled" th:if="${currentPage == 0}">Алдыңғы</span>

        <span th:each="i: ${#numbers.sequence(0, totalPages - 1)}"
              th:if="${i >= currentPage - 2 && i <= currentPage + 2}">
            <a class="page-item" th:classappend="${currentPage == i ? 'active' : ''}"
               th:href="@{/admin/logs(page=${i}, size=10, search=${search}, level=${level}, startDate=${startDate}, endDate=${endDate})}"
               th:text="${i + 1}">1</a>
        </span>

        <a class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}"
           th:href="@{/admin/logs(page=${currentPage + 1}, size=10, search=${search}, level=${level}, startDate=${startDate}, endDate=${endDate})}"
           th:unless="${currentPage == totalPages - 1}">Келесі</a>

        <span class="page-item disabled" th:if="${currentPage == totalPages - 1}">Келесі</span>
    </div>
</div>

<script>
    function toggleLogDetails(id) {
        const detailsElement = document.getElementById(`log-details-${id}`);
        if (detailsElement) {
            if (detailsElement.style.display === 'block') {
                detailsElement.style.display = 'none';
            } else {
                const allDetails = document.querySelectorAll('.log-details');
                allDetails.forEach(detail => {
                    detail.style.display = 'none';
                });

                detailsElement.style.display = 'block';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const clearLogsBtn = document.getElementById('clear-logs');
        if (clearLogsBtn) {
            clearLogsBtn.addEventListener('click', function() {
                if (confirm('Сіз барлық журналдарды тазалағыңыз келе ме?')) {
                    fetch('/admin/logs/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.text())
                        .then(message => {
                            const alertContainer = document.getElementById('admin-alert-container');
                            alertContainer.innerHTML = `<div class="alert alert-success">${message}</div>`;
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        })
                        .catch(error => {
                            const alertContainer = document.getElementById('admin-alert-container');
                            alertContainer.innerHTML = `<div class="alert alert-danger">Қате орын алды: ${error}</div>`;
                        });
                }
            });
        }

        const levelFilter = document.getElementById('level-filter');
        if (levelFilter) {
            levelFilter.addEventListener('change', function() {
                document.getElementById('page-input').value = 0;
                document.getElementById('filter-form').submit();
            });
        }
    });
</script>
</body>
</html>