<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">–ö—ñ—Ä—ñ—Å —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        .messages-container {
            max-width: 1000px;
            margin: 30px auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .messages-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .messages-title {
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .messages-nav {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ecf0f1;
        }

        .messages-nav-item {
            padding: 15px 20px;
            font-weight: 500;
            text-decoration: none;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .messages-nav-item:hover {
            color: #3498db;
        }

        .messages-nav-item.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .message-list {
            display: flex;
            flex-direction: column;
        }

        .message-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.3s;
            position: relative;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-item:hover {
            background-color: #f8f9fa;
        }

        .message-item.unread {
            background-color: #f0f8ff;
            border-left: 4px solid #3498db;
        }

        .message-item.unread:hover {
            background-color: #e6f3ff;
        }

        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .message-sender.unread {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-time {
            color: #95a5a6;
            font-size: 12px;
        }

        .message-subject {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .message-subject.unread {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-preview {
            color: #7f8c8d;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .message-preview.unread {
            color: #34495e;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        .empty-state-text {
            color: #7f8c8d;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .encryption-badge {
            display: inline-flex;
            align-items: center;
            background-color: #2ecc71;
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .encryption-icon {
            margin-right: 4px;
        }

        .unread-badge {
            width: 8px;
            height: 8px;
            background-color: #3498db;
            border-radius: 50%;
            margin-left: 10px;
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            background-color: #e74c3c;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
        }

        .priority-badge.medium {
            background-color: #f39c12;
        }

        .priority-badge.low {
            background-color: #95a5a6;
        }

        .message-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px;
        }

        .mark-read-btn {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .mark-read-btn:hover {
            background-color: #2980b9;
        }

        @media (max-width: 768px) {
            .messages-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .message-item {
                flex-direction: column;
            }

            .message-avatar {
                margin-bottom: 10px;
                margin-right: 0;
            }

            .message-actions {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="messages-container">
    <div class="messages-header">
        <h1 class="messages-title">–ö—ñ—Ä—ñ—Å —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä</h1>
        <div>
            <a th:href="@{/messages/compose}" class="btn btn-primary">–ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞</a>
        </div>
    </div>

    <div class="messages-nav">
        <a th:href="@{/messages/inbox}" class="messages-nav-item active">–ö—ñ—Ä—ñ—Å —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä</a>
        <a th:href="@{/messages/sent}" class="messages-nav-item">–ñ—ñ–±–µ—Ä—ñ–ª–≥–µ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä</a>
    </div>

    <div th:if="${!#lists.isEmpty(messages)}" class="message-list">
        <a th:each="message : ${messages}"
           th:href="@{/messages/{id}(id=${message.id})}"
           th:class="${'message-item' + (message.isRead ? '' : ' unread')}">

            <div class="message-content">
                <div class="message-header">
                    <div class="message-sender" th:class="${message.isRead ? 'message-sender' : 'message-sender unread'}">
                        <span th:text="${message.sender != null ? message.sender.fullName : '–ë–µ–ª–≥—ñ—Å—ñ–∑ –∂—ñ–±–µ—Ä—É—à—ñ'}">–ê—Å—ã–ª–±–µ–∫ –ù“±—Ä–ª–∞–Ω–æ–≤</span>

                        <span th:if="${message.priority == 'HIGH'}" class="priority-badge">–ñ–µ–¥–µ–ª</span>
                        <span th:if="${message.priority == 'MEDIUM'}" class="priority-badge medium">–û—Ä—Ç–∞—à–∞</span>
                        <span th:if="${message.priority == 'LOW'}" class="priority-badge low">–¢”©–º–µ–Ω</span>

                        <span th:if="${message.isEncrypted}" class="encryption-badge">
                            <i class="encryption-icon">üîí</i>–®–∏—Ñ—Ä–ª–∞–Ω“ì–∞–Ω
                        </span>

                        <span th:unless="${message.isRead}" class="unread-badge"></span>
                    </div>
                    <div class="message-actions">
                        <div class="message-time"
                             th:text="${message.timestamp != null ? #temporals.format(message.timestamp, 'dd.MM.yyyy HH:mm') : ''}">
                            15.10.2023 14:30
                        </div>
                    </div>
                </div>
                <div class="message-subject" th:class="${message.isRead ? 'message-subject' : 'message-subject unread'}"
                     th:text="${message.subject}">–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä–º–∞ —Ç—É—Ä–∞–ª—ã</div>
                <div class="message-preview" th:class="${message.isRead ? 'message-preview' : 'message-preview unread'}"
                     th:text="${message.content != null && #strings.length(message.content) > 100 ?
                                                         #strings.substring(message.content, 0, 100) + '...' :
                                                         message.content}">
                    –°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –°—ñ–∑–≥–µ –∂–∞“£–∞ —Ç–∞–ø—Å—ã—Ä–º–∞ –∂—ñ–±–µ—Ä—ñ–ø –æ—Ç—ã—Ä–º—ã–Ω. –ë“±–ª —Ç–∞–ø—Å—ã—Ä–º–∞–Ω—ã –∞–ø—Ç–∞–Ω—ã“£ —Å–æ“£—ã–Ω–∞ –¥–µ–π—ñ–Ω –æ—Ä—ã–Ω–¥–∞—É –∫–µ—Ä–µ–∫...
                </div>
            </div>
        </a>
    </div>

    <div th:if="${#lists.isEmpty(messages)}" class="empty-state">
        <div class="empty-state-icon">üì¨</div>
        <div class="empty-state-text">–°—ñ–∑–¥–µ –∂–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ“õ</div>
        <p style="color: #95a5a6; margin-bottom: 20px;">–ë–∞—Ä–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä—ã“£—ã–∑–¥—ã –æ—Å—ã –∂–µ—Ä–¥–µ–Ω –∫”©—Ä–µ –∞–ª–∞—Å—ã–∑</p>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
    function markAsRead(messageId, event) {
        event.preventDefault();
        event.stopPropagation();

        fetch('/messages/' + messageId + '/mark-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (response.ok) {
                    const messageItem = event.target.closest('.message-item');
                    if (messageItem) {
                        messageItem.classList.remove('unread');
                        const unreadElements = messageItem.querySelectorAll('.unread');
                        unreadElements.forEach(el => el.classList.remove('unread'));

                        const unreadBadge = messageItem.querySelector('.unread-badge');
                        if (unreadBadge) {
                            unreadBadge.remove();
                        }

                        event.target.remove();
                    }
                }
            })
            .catch(error => {
                console.error('–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –æ“õ—ã–ª“ì–∞–Ω —Ä–µ—Ç—ñ–Ω–¥–µ –±–µ–ª–≥—ñ–ª–µ—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã:', error);
            });
    }
</script>
</body>
</html>