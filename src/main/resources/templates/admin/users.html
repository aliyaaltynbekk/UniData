<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${pageTitle}">Пайдаланушылар тізімі</title>
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script th:src="@{/js/admin.js}" defer></script>
  <style>
    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .user-table th,
    .user-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ecf0f1;
    }

    .user-table th {
      background-color: #f8f9fa;
      color: #2c3e50;
      font-weight: 600;
      position: relative;
      cursor: pointer;
    }

    .user-table th:hover {
      background-color: #e9ecef;
    }

    .user-table th.sort-asc::after {
      content: " ▲";
      font-size: 12px;
    }

    .user-table th.sort-desc::after {
      content: " ▼";
      font-size: 12px;
    }

    .user-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .user-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-active {
      background-color: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background-color: #f8d7da;
      color: #721c24;
    }

    .user-role {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 500;
    }

    .role-admin {
      background-color: #2c3e50;
      color: #fff;
    }

    .role-teacher {
      background-color: #3498db;
      color: #fff;
    }

    .role-student {
      background-color: #2ecc71;
      color: #fff;
    }

    .user-actions {
      display: flex;
      gap: 5px;
    }

    .user-action-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .search-filters {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-group {
      flex: 1;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .filter-select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      background-color: white;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 30px;
    }

    .page-item {
      display: inline-block;
      min-width: 40px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .page-item:hover {
      background-color: #f8f9fa;
      border-color: #3498db;
    }

    .page-item.active {
      background-color: #3498db;
      color: white;
      border-color: #3498db;
    }

    .page-item.disabled {
      color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="admin-dashboard">
<div th:replace="fragments/sidebar :: adminSidebar"></div>

<div class="admin-content">
  <div class="admin-header">
    <h1 class="admin-title" th:text="${pageTitle}">Пайдаланушылар тізімі</h1>
  </div>

  <div id="admin-alert-container">
    <div th:if="${param.success}" class="alert alert-success">
      <span th:if="${param.success[0] == 'user_deleted'}">Пайдаланушы сәтті жойылды</span>
      <span th:if="${param.success[0] == 'user_created'}">Жаңа пайдаланушы сәтті құрылды</span>
      <span th:if="${param.success[0] == 'user_updated'}">Пайдаланушы ақпараты сәтті жаңартылды</span>
    </div>
    <div th:if="${param.error}" class="alert alert-danger">
      <span th:if="${param.error[0] == 'user_not_found'}">Пайдаланушы табылмады</span>
    </div>
  </div>

  <div class="search-filters">
    <div class="search-group">
      <input type="text" id="admin-search-input" class="search-input" placeholder="Іздеу...">
    </div>
  </div>

  <div class="table-responsive">
    <table class="user-table table">
      <thead>
      <tr>
        <th data-sort="id">ID</th>
        <th data-sort="name">Аты-жөні</th>
        <th data-sort="username">Пайдаланушы аты</th>
        <th data-sort="email">Email</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="user : ${users}" th:data-user-id="${user.id}">
        <td th:text="${user.id}">1</td>
        <td th:text="${user.fullName}">Азамат Ерлан</td>
        <td th:text="${user.username}">azamat</td>
        <td th:text="${user.email}">azamat@example.com</td>
        <td>
          <div class="user-actions">
            <button th:data-user-id="${user.id}"
                    data-action="delete"
                    class="btn btn-sm btn-danger user-action-btn"
                    onclick="handleUserAction(this)">
              Жою
            </button>
          </div>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(users)}">
        <td colspan="7" style="text-align: center; padding: 30px;">
          Пайдаланушылар табылмады
        </td>
      </tr>
      </tbody>
    </table>
  </div>

</div>
<script>
  function handleUserAction(button) {
    const userId = button.getAttribute('data-user-id');
    const action = button.getAttribute('data-action');

    let confirmMessage, url, method;

    switch(action) {
      case 'delete':
        confirmMessage = 'Бұл пайдаланушыны жоюға сенімдісіз бе?';
        url = `/admin/users/${userId}`;
        method = 'DELETE';
        break;
      default:
        console.error('Unknown action:', action);
        return;
    }

    if (confirm(confirmMessage)) {
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
              .then(response => {
                if (response.ok) {
                  if (action === 'delete') {
                    const row = button.closest('tr');
                    row.remove();
                    showAlert('Пайдаланушы сәтті жойылды', 'success');
                  } else {
                    location.reload();
                  }
                } else {
                  throw new Error('Request failed');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showAlert('Қате орын алды. Қайталап көріңіз.', 'error');
              });
    }
  }

  function showAlert(message, type) {
    const alertContainer = document.getElementById('admin-alert-container');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';

    alertContainer.innerHTML = `
        <div class="alert ${alertClass}" style="margin-bottom: 20px; padding: 15px; border-radius: 5px; ${type === 'success' ? 'background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 'background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'}">
          ${message}
        </div>
      `;

    setTimeout(() => {
      alertContainer.innerHTML = '';
    }, 5000);
  }
</script>
</body>
</html>